<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>






    <!-- 
        随机生成验证码
        Promise使用、Promise读取文件、Promise写文件优化、async/await
     -->

    <script>


        // 随机生成验证码
        {
            let Ran = function randomCode(length){
                let chars = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9']
                let res = ""
                for (let i = 0; i < length; i++) {
                    let index = Math.ceil(Math.random() * 9) // [0, 1) * 9 = [0, 9]
                    result += chars[index]
                }
                // console.log(res)
            }
            Ran(6)
        }




        // fs读取文件异步回调方式
        {
            function FileExtension () {

                fs.readFile(fileURL, function(err, data){
                    if(err){
                        // 文件不存在
                        res.writeHead(404, {"Content-Type":"text/html;charset=UTF8"})
                        res.end("404, 页面没有找到")
                    }
                    getMime(extname, function(mime){
                        res.writeHead(200, {"Content-Type": mime})
                        res.end(data)
                    }) 
                })
            }
            function getMime(extname, callback){
                // 读取mime.json文件 得到JSON 根据extname的key 返回对应的value
                fs.readFile("./mime.js", function(err, data){
                    if(err) {throw new Error("找不到mime.json文件"); return}
                    const mimeJSON = JSON.parse(data);
                    // ".json":"application/json"  ||  ".css":"text/css"
                    const mime = mimeJSON[extname] || "text/plain"
                    // mime   text/html | text/css | 
                    callback(mime)
                })
            }
        }

//--------------------------异步方案--------------------------------
        {
            {
                // 普通回调
                function doSomething(cb){
                    setTimeout(function() {
                        cb("完成")
                    }, 1000)
                }
                // doSomething(function(arg){
                //     console.log( "done here" , arg);
                // })
            } 
            {  
                // Promise回调
                function doSomething2(){
                    return new Promise((reslove, reject) => {
                        setTimeout(function(){
                            reslove("promise 成功")
                        }, 2000)
                    }) 
                }
                // doSomething2().then(function(res) {
                //     console.log(res)
                // })
            }
            {
                // Promise异步读取文件回调 finally
                function getFile(fPath){
                    return new Promise((reslove, reject) => {
                        fs.readFile(fPath, "UTF-8", function (err, dataStr) {
                            if(err) return reject(err);
                            reslove(dataStr)
                        })
                    })
                }
                // getFile("./files/1.txt").then(value => {
                //     console.log(value)
                // }).catch(error => {
                //     console.log(error)
                // }).finally(() => console.log('finished'));
            }
            {
                // promise 代码优化
                // // bad
                    // request(url, function(err, res, body) {
                    //     if (err) handleError(err);
                    //     fs.writeFile('1.txt', body, function(err) {
                    //         request(url2, function(err, res, body) {
                    //             if (err) handleError(err)
                    //         })
                    //     })
                    // });
                    
                    // // good
                    // request(url)
                    // .then(function(result) {
                    //     return writeFileAsynv('1.txt', result)
                    // })
                    // .then(function(result) {
                    //     return request(url2)
                    // })
                    // .catch(function(e){
                    //     handleError(e)
                    // }); 
            }
            {
                // async/await
                {
                    async function getItems() {
                        try {
                            const user = await getUser()
                            const order = await getOrderByUser(user)
                            const items = await getOrderItemsByOrder(order)
                            return items
                        } catch (error) {
                            // 在这里处理错误，建议返回某个值或者重新抛出错误
                        }
                    }
                    // getItems().then(item => {
                    //     // 处理排序后的成员
                    // })
                }
            }
        }
    </script>
  </body>
</html>
